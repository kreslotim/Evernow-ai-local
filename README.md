# Evernow-ai - NestJS Backend

–£–ø—Ä–æ—â—ë–Ω–Ω—ã–π Telegram bot backend –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º NestJS, OpenAI Vision API –∏ —Å–∏—Å—Ç–µ–º—ã –æ—á–µ—Ä–µ–¥–µ–π.

## üöÄ Features

- **–£–ø—Ä–æ—â—ë–Ω–Ω—ã–π –±–æ—Ç –∞–Ω–∞–ª–∏–∑–∞** - –ï–¥–∏–Ω—ã–π —Ç–∏–ø –∞–Ω–∞–ª–∏–∑–∞ DEFAULT –¥–ª—è 2 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
- **OpenAI Vision API** - –ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º GPT-4 Vision
- **–°–∏—Å—Ç–µ–º–∞ –æ—á–µ—Ä–µ–¥–µ–π** - –§–æ–Ω–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π —á–µ—Ä–µ–∑ Redis/BullMQ
- **JWT Authentication** - –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
- **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - Redis pub/sub —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- **–°–∏—Å—Ç–µ–º–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤** - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞–º–∏ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –≤–æ–∑–≤—Ä–∞—Ç–æ–º –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- **I18n –ø–æ–¥–¥–µ—Ä–∂–∫–∞** - –ú–Ω–æ–≥–æ—è–∑—ã—á–Ω–æ—Å—Ç—å —Å —à–∞–±–ª–æ–Ω–∞–º–∏ `{{–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è}}`
- **–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞** - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö —Ä–µ—Ñ–µ—Ä–∞–ª–∞—Ö
- **Admin API** - REST API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –∞–Ω–∞–ª–∏–∑–∞–º–∏
- **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –±–æ—Ç–æ–≤** - –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –ø–æ–∏—Å–∫** - –ü–∞–≥–∏–Ω–∞—Ü–∏—è, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¥–ª—è –≤—Å–µ—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π
- **Telegram Mini App** - –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
- **–ï–¥–∏–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞** - –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –æ—Ç –∞–Ω–∞–ª–∏–∑–∞ –¥–æ —Å–æ–∑–¥–∞–Ω–∏—è –≥–∏–ø–æ—Ç–µ–∑
- **DeepSeek AI –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** - –ê–Ω–∞–ª–∏–∑ —á—É–≤—Å—Ç–≤ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –≥–∏–ø–æ—Ç–µ–∑
- **Whisper API** - –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üìÅ Project Structure

```
src/
‚îú‚îÄ‚îÄ bot/                    # Telegram bot logic (—É–ø—Ä–æ—â—ë–Ω–Ω—ã–π)
‚îÇ   ‚îú‚îÄ‚îÄ guards/            # NestJS guards (banned-user.guard.ts)
‚îÇ   ‚îú‚îÄ‚îÄ handlers/          # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ analyze.handler.ts   # –£–ø—Ä–æ—â—ë–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–ª—è 2 —Ñ–æ—Ç–æ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ start.handler.ts     # –ö–æ–º–∞–Ω–¥–∞ /start
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ balance.handler.ts   # –ë–∞–ª–∞–Ω—Å –∫—Ä–µ–¥–∏—Ç–æ–≤
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ referral.handler.ts  # –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ support.handler.ts   # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ /help
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ onboarding.handler.ts # –ï–¥–∏–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
‚îÇ   ‚îú‚îÄ‚îÄ services/          # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –±–æ—Ç–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ keyboard.service.ts  # –ì–ª–æ–±–∞–ª—å–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ bot.service.ts       # –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ middleware/        # Middleware –¥–ª—è –±–æ—Ç–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ keyboard-handler.middleware.ts  # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ onboarding.middleware.ts       # –ü—Ä–æ—Å—Ç–æ–π pass-through
‚îÇ   ‚îú‚îÄ‚îÄ i18n/             # –ò–Ω—Ç–µ—Ä–Ω–∞—Ü–∏–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ i18n.service.ts      # I18n —Å —à–∞–±–ª–æ–Ω–∞–º–∏ {{–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è}}
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ locales/       # –§–∞–π–ª—ã –ø–µ—Ä–µ–≤–æ–¥–æ–≤ (ru.json, en.json)
‚îÇ   ‚îî‚îÄ‚îÄ decorators/        # –î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã (@SkipGuards)
‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin/         # Admin panel API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user/          # User management service with payment notifications
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ analyze/       # Analysis management service
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ queue/         # –§–æ–Ω–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞–Ω–∏–π
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ processors/ # –ü—Ä–æ—Ü–µ—Å—Å–æ—Ä—ã –æ—á–µ—Ä–µ–¥–µ–π
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ photo-analysis.processor.ts # OpenAI –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ openai/        # OpenAI Vision API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ telegram/      # –°–µ—Ä–≤–∏—Å –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ Telegram
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ notification/  # Redis pub/sub —Å–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ referral/      # –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/          # JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config/        # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mini-app/      # Telegram Mini App –º–æ–¥—É–ª—å
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ static/    # HTML/CSS/JS —Ñ–∞–π–ª—ã –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ README.md  # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ llm/           # AI —Å–µ—Ä–≤–∏—Å—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ deepseek/  # DeepSeek Reasoning API
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ openai/    # OpenAI GPT-4 Vision API
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ whisper/   # OpenAI Whisper API –¥–ª—è –≥–æ–ª–æ—Å–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ timer/         # –°–µ—Ä–≤–∏—Å —Ç–∞–π–º–µ—Ä–æ–≤ –¥–ª—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ user-info/     # –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îÇ   ‚îî‚îÄ‚îÄ prisma/            # Database service
‚îú‚îÄ‚îÄ common/
‚îÇ   ‚îú‚îÄ‚îÄ interfaces/        # –û–±—â–∏–µ TypeScript –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
‚îÇ   ‚îú‚îÄ‚îÄ dtos/             # Data Transfer Objects —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
‚îÇ   ‚îú‚îÄ‚îÄ enums/            # –ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ utils/            # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
‚îú‚îÄ‚îÄ uploads/
‚îÇ   ‚îî‚îÄ‚îÄ photos/           # –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
‚îú‚îÄ‚îÄ src/fonts/            # –®—Ä–∏—Ñ—Ç—ã (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è image processing)
‚îÇ   ‚îî‚îÄ‚îÄ Evolventa-Regular.ttf  # –®—Ä–∏—Ñ—Ç Evolventa
‚îú‚îÄ‚îÄ src/common/
‚îÇ   ‚îú‚îÄ‚îÄ backgrounds/      # –§–æ–Ω–æ–≤—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (1.png, 2.png, 3.png, 4.png)
‚îÇ   ‚îî‚îÄ‚îÄ video/           # –í–∏–¥–µ–æ —Ñ–∞–π–ª—ã (1.mp4)
‚îî‚îÄ‚îÄ src/bot/prompts/      # –ü—Ä–æ–º–ø—Ç—ã –¥–ª—è OpenAI –∞–Ω–∞–ª–∏–∑–∞
    ‚îú‚îÄ‚îÄ fast_analyze.txt  # –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –æ—Å—Ç–∞–≤—à–∏–π—Å—è –ø—Ä–æ–º–ø—Ç
    ‚îî‚îÄ‚îÄ summary.txt       # –ü—Ä–æ–º–ø—Ç –¥–ª—è —Ä–µ–∑—é–º–µ
```

## üõ†Ô∏è Technology Stack

- **Framework**: NestJS
- **Database**: PostgreSQL with Prisma ORM
- **Queue**: Redis with BullMQ
- **Bot**: Telegraf with advanced middleware system
- **AI**: OpenAI GPT-4 Vision API
- **Image Processing**: Sharp library for social media image generation
- **Authentication**: JWT with @nestjs/jwt
- **Notifications**: Redis pub/sub
- **I18n**: Custom template interpolation system
- **Validation**: class-validator
- **Documentation**: Swagger/OpenAPI
- **Language**: TypeScript

## üìã Prerequisites

- Node.js 18+
- PostgreSQL
- Redis
- Telegram Bot Token
- OpenAI API Key

## üîß Installation

```bash
# Install dependencies
npm install

# Install JWT package (required for auth)
npm install @nestjs/jwt

# Generate Prisma client
npx prisma generate

# Run database migrations
npx prisma migrate deploy
```

## ‚öôÔ∏è Configuration

Create `.env` file:

```env
# Database
DATABASE_URL="postgresql://user:password@localhost:5432/facebot"

# Redis
REDIS_URL="redis://localhost:6379"

# Telegram Bot
BOT_TOKEN="your_telegram_bot_token"
BOT_WEBHOOK_URL="https://yourdomain.com" # for production
BOT_WEBHOOK_PATH="/webhook"
BOT_WEBHOOK_SECRET="your_webhook_secret"

# OpenAI
OPENAI_API_KEY="your_openai_api_key_here"

# DeepSeek AI (–¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —á—É–≤—Å—Ç–≤ –∏ –≥–∏–ø–æ—Ç–µ–∑)
DEEPSEEK_API_KEY="your_deepseek_api_key"

# Admin Authentication
ADMIN_PASSWORD="your_admin_password"
JWT_SECRET="your_jwt_secret_key"
JWT_EXPIRES_IN="24h"

# Channels (optional)
REQUIRED_CHANNELS="@channel1,@channel2"
SUBSCRIPTION_CHECK_ACTIVE=true

# App
NODE_ENV="development"
APP_PORT=4001

# Links for onboarding
REPOST_VIDEO_URL="https://example.com/video"
OFFER_URL="https://example.com/offer"
PRIVACY_POLICY_URL="https://example.com/privacy"

# OpenRouter API –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
OPENROUTER_API_KEY=your_openrouter_api_key_here
OPENROUTER_BASE_URL=https://openrouter.ai/api/v1
USE_OPENROUTER=true
```

## üöÄ Running the Application

```bash
# Development
npm run start:dev

# Production
npm run build
npm run start:prod

# Watch mode
npm run start:dev
```

## üìö API Documentation

### Admin API

Complete admin panel API documentation available at:

- **Swagger UI**: `http://localhost:4001/api/docs` (when running)
- **API Documentation**: [docs.api.md](./docs.api.md)

### Authentication

```
POST   /auth/login           # Admin login with JWT
```

### Key API Endpoints

```
GET    /admin/dashboard        # Dashboard statistics
GET    /admin/users           # List users with pagination
GET    /admin/users/:id       # Get user details
PUT    /admin/users/:id       # Update user
POST   /admin/users/:id/ban   # Ban user
GET    /admin/analyzes        # List analyses with filtering
```

## üèóÔ∏è Architecture

### Core Modules

#### **OpenAIModule** (`src/core/modules/openai/`)

- **Vision API Integration**: GPT-4 Vision for photo analysis
- **Specialized Prompts**: 6 different analysis types with custom prompts
- **Image Processing**: Base64 encoding and MIME type detection
- **Error Handling**: Comprehensive error handling and logging

#### **NotificationModule** (`src/core/modules/notification/`)

- **Redis Pub/Sub**: Real-time messaging between services
- **Typed Messages**: Structured notification system
- **Multi-language Support**: Automatic message localization
- **Connection Management**: Robust Redis connection handling

#### **TelegramModule** (`src/core/modules/telegram/`)

- **File Downloads**: Real Telegram file downloads via Bot API
- **Local Storage**: Automatic directory creation and file management
- **Error Recovery**: Comprehensive error handling for file operations

#### **AuthModule** (`src/core/modules/auth/`)

- **JWT Authentication**: Secure token-based authentication
- **Admin Login**: Environment-based admin password validation
- **Token Validation**: Middleware for protected routes
- **Role-based Access**: Admin role management

#### **UserModule** (`src/core/modules/user/`)

- User management for Telegram bot
- Credit system operations
- **Payment Notifications**: Real-time payment success/failure notifications
- Ban/unban functionality
- User statistics and search

#### **AnalyzeModule** (`src/core/modules/analyze/`)

- Analysis lifecycle management
- Queue integration for processing
- Status tracking and error handling
- Statistics by type and status

#### **ReferralModule** (`src/core/modules/referral/`)

- **Enhanced Referral System**: Real-time referral notifications
- **Bonus Tracking**: 3rd referral bonus notifications
- **Notification Integration**: Redis pub/sub for instant messaging

#### **AdminModule** (`src/core/modules/admin/`)

- REST API for admin panel
- Aggregates User and Analyze services
- Comprehensive CRUD operations
- Advanced filtering and pagination

### Bot Architecture

#### **AnalysisCheckMiddleware** (`src/bot/middleware/analysis-check.middleware.ts`)

- **Smart Token Validation**: Intelligent credit checking before analysis
- **User Guidance**: Dynamic button generation based on user state
- **Conditional Actions**: "Buy Tokens" and "Earn Token" buttons
- **Seamless Integration**: Works with existing analyze handler

#### **BotService** (`src/bot/services/bot.service.ts`)

- **Notification Handling**: Redis subscription for real-time messages
- **Multi-language Support**: Automatic message localization
- **Message Types**: Referral, payment, and bonus notifications
- **Error Recovery**: Robust error handling for message delivery

#### **AnalyzeHandler** (`src/bot/handlers/analyze.handler.ts`)

- **Complete Analysis Flow**: From type selection to result delivery
- **Session Management**: User state tracking during analysis
- **Photo Processing**: Support for photos and documents
- **Queue Integration**: Seamless background processing

#### **I18nService** (`src/bot/i18n/i18n.service.ts`)

- **Template Interpolation**: Supports `{{variable}}` syntax with dynamic value replacement
- **Multi-language Support**: Structured JSON locale files with nested keys
- **Type Safety**: Map-based and object-based variable passing
- **Convenience Methods**: `t()` method for simplified translations

```typescript
// Template interpolation example
const message = i18nService.t('notifications.new_referral', 'ru', {
  referralCount: 5,
});
// Result: "üéâ –£ —Ç–µ–±—è –Ω–æ–≤—ã–π —Ä–µ—Ñ–µ—Ä–∞–ª! –í—Å–µ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤: 5"
```

#### **KeyboardService** (`src/bot/services/keyboard.service.ts`)

- **Localized Keyboards**: Automatically translated buttons based on user locale
- **Static Layout**: Fixed main keyboard (Analysis, Balance, Referral, Help)
- **Button Detection**: Smart identification of keyboard button presses
- **Utility Methods**: Back keyboards and keyboard removal

#### **KeyboardHandlerMiddleware** (`src/bot/middleware/keyboard-handler.middleware.ts`)

- **Global Navigation**: Intercepts keyboard presses across all bot scenes
- **Scene-Aware**: Automatically navigates to target scenes from any context
- **Error Handling**: Robust error handling with localized messages
- **Context Integration**: Seamless Telegraf context integration

### Queue Processing

#### **PhotoAnalysisProcessor** (`src/core/modules/queue/processors/photo-analysis.processor.ts`)

- **Real File Downloads**: Telegram file downloads via TelegramService
- **OpenAI Integration**: GPT-4 Vision API processing
- **Social Media Image Generation**: Automated creation of shareable images with analysis summaries
- **Business Logic Optimization**: Summary and social images only for first-time users
- **Fraud Prevention**: Three-strike ban system for repeated analysis failures
- **Notification System**: Success/failure notifications via Redis
- **Database Updates**: Analysis result storage and status tracking
- **Cleanup**: Automatic temporary file cleanup

### Interfaces & DTOs

**Centralized Interfaces** (`src/common/interfaces/`):

- `UserWithStats` - User with analysis/referral counts
- `AnalyzeWithUser` - Analysis with user details
- `DashboardStats` - Admin dashboard statistics
- `NotificationMessage` - Typed notification messages

**Validated DTOs** (`src/common/dtos/`):

- Full Swagger documentation with `@ApiProperty`
- Input validation with `class-validator`
- Type-safe data transfer

## üåê Bot Features

### –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∞

- **–ï–¥–∏–Ω—ã–π —Ç–∏–ø –∞–Ω–∞–ª–∏–∑–∞**: –¢–æ–ª—å–∫–æ DEFAULT —Ç–∏–ø –¥–ª—è –≤—Å–µ—Ö –∞–Ω–∞–ª–∏–∑–æ–≤
- **2 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç 2 —Ñ–æ—Ç–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
- **OpenAI Vision**: AI –∞–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º GPT-4 Vision
- **–û—á–µ—Ä–µ–¥–∏**: –§–æ–Ω–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ Redis/BullMQ
- **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**: –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —á–µ—Ä–µ–∑ Redis pub/sub

### –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–µ–¥–∏—Ç–∞–º–∏

- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤ –ø–µ—Ä–µ–¥ –∞–Ω–∞–ª–∏–∑–æ–º
- **–í–æ–∑–≤—Ä–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤–æ–∑–≤—Ä–∞—Ç –∫—Ä–µ–¥–∏—Ç–æ–≤ –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ
- **–ü—Ä–æ—Å—Ç–æ–π –ø–æ—Ç–æ–∫**: –£–¥–æ–±–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

- **–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**: –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö —Ä–µ—Ñ–µ—Ä–∞–ª–∞—Ö
- **–ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è–º

### –ì–ª–æ–±–∞–ª—å–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞

- **–í—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞**: –û—Å–Ω–æ–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–∑ –ª—é–±–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- **–õ–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–∞**: –ö–Ω–æ–ø–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–≤–æ–¥—è—Ç—Å—è
- **–ù–∞–≤–∏–≥–∞—Ü–∏—è**: –ê–Ω–∞–ª–∏–∑, –ë–∞–ª–∞–Ω—Å, –†–µ—Ñ–µ—Ä–∞–ª—ã, –ü–æ–º–æ—â—å
- **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è**: –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –ü–æ–¥–¥–µ—Ä–∂–∫–∞ I18n

- **–®–∞–±–ª–æ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ**: `{{name}}`, `{{count}}` —Å –∞–≤—Ç–æ–∑–∞–º–µ–Ω–æ–π
- **–í–ª–æ–∂–µ–Ω–Ω—ã–µ –∫–ª—é—á–∏**: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–¥—ã (`notifications.new_referral`)
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —Ç–∏–ø–æ–≤**: –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ TypeScript

### Telegram Mini App - –¶–≤–µ—Ç–æ–≤–æ–π —Ç–µ—Å—Ç –õ—é—à–µ—Ä–∞

- **–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ü–≤–µ—Ç–æ–≤–æ–π —Ç–µ—Å—Ç**: –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç –õ—é—à–µ—Ä–∞ —Å 8 —Ü–≤–µ—Ç–∞–º–∏
- **–î–≤–∞ –∫—Ä—É–≥–∞ –≤—ã–±–æ—Ä–∞**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Ö–æ–¥–∏—Ç —Ç–µ—Å—Ç –¥–≤–∞–∂–¥—ã –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è —Ç–æ—á–Ω–æ—Å—Ç–∏
- **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤**: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ø–æ–ª–µ `luscherTestResult` —Ç–∞–±–ª–∏—Ü—ã `UserInfo`
- **–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑**: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π, –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Å—Ç—Ä–µ—Å—Å–∞ –∏ –∫–ª—é—á–µ–≤—ã—Ö –∏—Å—Ç–∏–Ω
- **–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**: –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ Telegram —á–µ—Ä–µ–∑ HMAC-SHA256
- **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–µ–º Telegram –∏ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- **–ï–¥–∏–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω**: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ —á–µ—Ä–µ–∑ Redis –æ—á–µ—Ä–µ–¥–∏

### –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –æ–Ω–±–æ—Ä–¥–∏–Ω–≥

- **–ï–¥–∏–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω**: –û—Ç –∞–Ω–∞–ª–∏–∑–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –¥–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –≥–∏–ø–æ—Ç–µ–∑
- **–¢–∞–π–º–µ—Ä-—Å–∏—Å—Ç–µ–º–∞**: 3-–º–∏–Ω—É—Ç–Ω—ã–µ —Ç–∞–π–º–µ—Ä—ã —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
- **–ê–Ω–∞–ª–∏–∑ —á—É–≤—Å—Ç–≤**: DeepSeek AI –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–∫—Å—Ç–∞ –∏ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- **Whisper –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**: –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ç–µ–∫—Å—Ç
- **–ë–ª–æ–∫-–≥–∏–ø–æ—Ç–µ–∑—ã**: –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∏–Ω—Å–∞–π—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö
- **–°–∏—Å—Ç–µ–º–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏**: –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –±–∞–Ω–æ–º

### –ü—Ä–æ—Å—Ç–æ–π –ø—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞

```typescript
// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ—Ç–∞ —Å —É–ø—Ä–æ—â—ë–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π
bot.use(keyboardHandlerMiddleware.getMiddleware());

// –£–ø—Ä–æ—â—ë–Ω–Ω—ã–π –ø–æ—Ç–æ–∫ –∞–Ω–∞–ª–∏–∑–∞
bot.command('start', async (ctx) => {
  // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –æ—Å–Ω–æ–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
});

// –ï–¥–∏–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è 2 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
bot.on('photo', async (ctx) => {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤, —Å–æ–∑–¥–∞–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞ –≤ –ë–î, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –æ—á–µ—Ä–µ–¥—å
  // –¢–∏–ø –∞–Ω–∞–ª–∏–∑–∞ –≤—Å–µ–≥–¥–∞ DEFAULT
});

// –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
notificationService.publishNotification({
  type: 'new_referral',
  userId: 'user123',
  data: { referralCount: 5 },
});
```

## üß™ Testing

```bash
# Unit tests
npm run test

# E2E tests
npm run test:e2e

# Test coverage
npm run test:cov
```

## üìä Database Schema

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Prisma —Å PostgreSQL:

- **User** - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ Telegram —Å –∫—Ä–µ–¥–∏—Ç–∞–º–∏, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏, –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π –±–æ—Ç–∞
- **Analyze** - –ó–∞–ø–∏—Å–∏ –∞–Ω–∞–ª–∏–∑–∞ —Ñ–æ—Ç–æ —Å –µ–¥–∏–Ω—ã–º —Ç–∏–ø–æ–º DEFAULT
- **Referral** - –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
- **Offer** - –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å title/description
- **UserInfo** - –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ (–≤–∫–ª—é—á–∞—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞ –õ—é—à–µ—Ä–∞)
- **UserTimer** - –¢–∞–π–º–µ—Ä—ã –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞

–ü–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞: [prisma/schema.prisma](./prisma/schema.prisma)

## üîê Security

- **JWT Authentication**: Secure admin authentication with configurable expiration
- **Input validation**: Comprehensive validation on all endpoints
- **User ban system**: Ban system with reason tracking
- **Environment-based configuration**: Secure credential management
- **Type-safe database operations**: Prisma-based type safety

## üìà Performance

- **Queue-based async processing**: Background photo analysis
- **Redis pub/sub**: Real-time notifications without polling
- **Pagination**: Efficient handling of large datasets
- **Efficient database queries**: Optimized Prisma queries
- **Memory-optimized i18n**: Efficient locale loading
- **Global middleware**: Optimal keyboard and analysis handling

## üöÄ Deployment

1. **Install dependencies**: `npm install && npm install @nestjs/jwt`
2. **Set environment variables**: Configure all required env vars
3. **Install system dependencies**: `fontconfig libvips-dev` for image processing
4. **Setup fonts**: Ensure Evolventa font is available system-wide
5. **Database setup**: `npx prisma migrate deploy`
6. **Build application**: `npm run build`
7. **Start production**: `npm run start:prod`

### Required Environment Variables

- `DATABASE_URL` - PostgreSQL connection string
- `REDIS_URL` - Redis connection string
- `BOT_TOKEN` - Telegram bot token
- `OPENAI_API_KEY` - OpenAI API key
- `DEEPSEEK_API_KEY` - DeepSeek API key
- `ADMIN_PASSWORD` - Admin authentication password
- `JWT_SECRET` - JWT signing secret
- `JWT_EXPIRES_IN` - JWT token expiration (e.g., "24h")

## üìù Contributing

1. Follow TypeScript best practices
2. Use proper naming conventions (camelCase, PascalCase)
3. Document public APIs with JSDoc
4. Write tests for new features
5. Maintain clean code principles
6. Use i18n for all user-facing text
7. Leverage global keyboard system for navigation
8. Implement proper error handling and logging
9. Use notification system for real-time updates

## üìû Support

For support and questions, please check the API documentation or create an issue.

## üìÑ License

This project is proprietary software.

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å OpenRouter:

```bash
# OpenRouter API –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
OPENROUTER_API_KEY=your_openrouter_api_key_here
OPENROUTER_BASE_URL=https://openrouter.ai/api/v1
USE_OPENROUTER=true

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –ø—Ä—è–º—ã–º OpenAI
OPENAI_API_KEY=your_openai_api_key_here
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è OpenRouter

- `OPENROUTER_API_KEY` - API –∫–ª—é—á –æ—Ç OpenRouter.ai
- `OPENROUTER_BASE_URL` - –ë–∞–∑–æ–≤—ã–π URL –¥–ª—è OpenRouter API (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: https://openrouter.ai/api/v1)
- `USE_OPENROUTER` - –í–∫–ª—é—á–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ OpenRouter –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ OpenAI (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: true)

### –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –º–æ–¥–µ–ª–∏

- **–ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ**: `openai/o3` - –æ—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è summary**: `openai/gpt-4o-mini` - –º–æ–¥–µ–ª—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫—Ä–∞—Ç–∫–∏—Ö —Ä–µ–∑—é–º–µ
