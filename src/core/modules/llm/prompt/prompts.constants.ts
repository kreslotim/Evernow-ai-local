import * as fs from 'fs';
import * as path from 'path';

/**
 * Перечисление ключей промптов для всех LLM сервисов
 */
export enum PromptKey {
  OPENAI_MAIN_ANALYSIS = 'openai_main_analysis',
  OPENAI_SUMMARY = 'openai_summary',
  OPENAI_BLOCK_HYPOTHESIS = 'openai_block_hypothesis',
  OPENAI_FULL_ANALYSIS = 'openai_full_analysis',
  OPENAI_SECOND_ORDER_HYPOTHESIS = 'openai_second_order_hypothesis',
  OPENAI_ANALYZE_PHOTOS = 'openai_analyze_photos',
  OPENAI_ANALYZE_FACE = 'openai_analyze_face',
  OPENAI_ANALYZE_PALM = 'openai_analyze_palm',
  DEEPSEEK_FEELINGS_ANALYSIS = 'deepseek_feelings_analysis',
  DEEPSEEK_BLOCK_HYPOTHESIS = 'deepseek_block_hypothesis', // Оставляем для совместимости
  DEEPSEEK_SECOND_ORDER_HYPOTHESIS = 'deepseek_second_order_hypothesis', // Оставляем для совместимости
  DEEPSEEK_VALIDATE_MESSAGE = 'deepseek_validate_message',
}

/**
 * Метаданные промптов с описаниями и провайдерами
 */
export interface PromptMetadata {
  description: string;
  provider: 'openai' | 'deepseek';
  variables?: string[]; // Список переменных для подстановки в промпт
  deprecated?: boolean; // Помечает устаревшие промпты, которые не должны отображаться в админке
}

/**
 * Объект с метаданными для каждого промпта
 */
export const PROMPT_METADATA: Record<PromptKey, PromptMetadata> = {
  [PromptKey.OPENAI_MAIN_ANALYSIS]: {
    description: 'Основной промпт для анализа фотографий лица и ладони через физиогномику и хиромантию',
    provider: 'openai',
  },
  [PromptKey.OPENAI_SUMMARY]: {
    description: 'Промпт для создания краткого резюме анализа физиогномики в 3 предложения',
    provider: 'openai',
  },
  [PromptKey.OPENAI_BLOCK_HYPOTHESIS]: {
    description: 'Создание блок-гипотезы на основе анализа фото и чувств пользователя через OpenAI o3',
    provider: 'openai',
    variables: ['analysisDescription', 'feelings', 'feelingsAnalysis'],
  },
  [PromptKey.OPENAI_SECOND_ORDER_HYPOTHESIS]: {
    description: 'Создание альтернативной гипотезы второго порядка через OpenAI o3 при отклонении первой',
    provider: 'openai',
    variables: ['analysisDescription', 'feelings', 'previousHypothesis'],
  },
  [PromptKey.OPENAI_FULL_ANALYSIS]: {
    description: 'Полный анализ фотографий в одном запросе используя промпт full.txt',
    provider: 'openai',
    variables: ['test'],
  },
  [PromptKey.OPENAI_ANALYZE_PHOTOS]: {
    description: 'Валидационный анализ фотографий на фрагменты запрещенного контента',
    provider: 'openai',
  },
  [PromptKey.OPENAI_ANALYZE_FACE]: {
    description: 'Валидационный анализ фотографии лица на фрагменты запрещенного контента',
    provider: 'openai',
  },
  [PromptKey.OPENAI_ANALYZE_PALM]: {
    description: 'Валидационный анализ фотографии ладоней на фрагменты запрещенного контента',
    provider: 'openai'
  },
  [PromptKey.DEEPSEEK_FEELINGS_ANALYSIS]: {
    description: 'Анализ текста о чувствах пользователя после просмотра результатов',
    provider: 'deepseek',
    variables: ['text'],
  },
  [PromptKey.DEEPSEEK_BLOCK_HYPOTHESIS]: {
    description: 'Создание блок-гипотезы на основе анализа фото и чувств пользователя (устаревший)',
    provider: 'deepseek',
    variables: ['analysisDescription', 'feelings', 'feelingsAnalysis'],
    deprecated: true,
  },
  [PromptKey.DEEPSEEK_SECOND_ORDER_HYPOTHESIS]: {
    description: 'Создание альтернативной гипотезы второго порядка при отклонении первой (устаревший)',
    provider: 'deepseek',
    variables: ['analysisDescription', 'feelings', 'previousHypothesis'],
    deprecated: true,
  },
  [PromptKey.DEEPSEEK_VALIDATE_MESSAGE]: {
    description: 'Валидация голосового сообщения пользователя',
    provider: 'deepseek',
  }
};

/**
 * Функция для загрузки промпта из файла
 * @param filename - имя файла в директории src/bot/prompts/
 * @returns содержимое файла как строка
 */
function loadPromptFromFile(filename: string): string {
  try {
    const filePath = path.join(process.cwd(), 'src', 'core', 'modules', 'llm', 'prompt', 'prompts', filename);
    return fs.readFileSync(filePath, 'utf-8').trim();
  } catch (error) {
    console.warn(`Не удалось загрузить промпт из файла ${filename}:`, error.message);
    return '';
  }
}

/**
 * Объект с промптами по умолчанию для всех ключей
 */
export const DEFAULT_PROMPTS: Record<PromptKey, string> = {
  [PromptKey.OPENAI_MAIN_ANALYSIS]: loadPromptFromFile('default.txt'),

  [PromptKey.OPENAI_SUMMARY]: loadPromptFromFile('summary.txt'),

  [PromptKey.OPENAI_BLOCK_HYPOTHESIS]: `Используя приведённые данные, которые тебе присылают, сформируй структурированную блок-гипотезу о человеке, его амбициях и внутренних ограничениях.

Сформируй ответ в точном формате ниже (без markdown-разметки, только чистый текст; между разделами — два пустых абзаца, внутри раздела — перенос после каждой мысли).

Структура ответа:

Инсайты  
– 3-4 коротких тезиса, объединяющих визуальный анализ и эмоциональное состояние, пишем в уверенном экспертном тоне от третьего лица.

Что отпустить с благодарностью, что взрастить  
– 3-4 пары «было → стало», где слева ограничивающий паттерн, справа конструктивное действие или настрой.

Дорожная карта роста  
– 3-4 конкретных шага-привычки, начинаем каждым пунктом с глагола в инфинитиве («Делегировать…», «Практиковать…»).

Итог  
– 2-3 предложения, подводящие итог, показывающие ценность уже сформированных качеств и главный вектор дальнейшего развития.

Дополнительные требования  
1. Используй тире «–» для списков и стрелку «→» для трансформаций.  
2. Пиши короткими, энергичными утверждениями в стиле психологического инсайта.  
3. Избегай лишних вводных слов, клише и оценочных эпитетов.  
4. Общий объём — 10–14 содержательных строк (без учёта заголовков).

Стиль — как у личного психолога-менторa: точные, по делу, но поддерживающие формулировки.  
Не используй markdown или форматирование, делай двойной абзацный пробел между разделами.  
Пиши во 2-м лице ("вы"), как будто это персональный разбор.

`,

  [PromptKey.OPENAI_SECOND_ORDER_HYPOTHESIS]: `Пользователь отклонил следующую гипотезу:
"\${previousHypothesis}"

Данные для анализа:
- Анализ фото: \${analysisDescription}
- Описание чувств: \${feelings}
Анализ эмоционального состояния: \${feelingsAnalysis}

Создай новую, на 8-10 более глубокую гипотезу второго порядка, которая:
1. Предлагает альтернативную интерпретацию, учитывая возможное сопротивление или более глубокие слои проблемы.
2. Фокусируется на менее очевидных связях между амбициями и внутренними блоками.
3. Написана в еще более эмпатичном и поддерживающем тоне.

Отправь результат без markdown вёрстки с двойными переносами строк между абзацами.`,

  [PromptKey.OPENAI_FULL_ANALYSIS]: loadPromptFromFile('full.txt'),

  [PromptKey.OPENAI_ANALYZE_PHOTOS]: `Ты валидатор изображений. Пользователь присылает 3 изображения:
- 1-е фото должно быть с лицом
- 2-е и 3-е фото — с ладонями

Оцени соответствие требованиям по шкале от -2 до +2 и верни только JSON в формате:

{ "rating": number }

Где:

-2 — всё неправильно  
-1 — только одно фото (лицо или ладонь) возможно верно  
 0 — частичное соответствие или сомнение  
+1 — соответствие с неуверенностью  
+2 — полное соответствие и высокая уверенность

⚠️ Не добавляй объяснений, комментариев, никаких других данных — только JSON вида: { "rating": число }
Если сомневаешься — снижай рейтинг.`,

  [PromptKey.OPENAI_ANALYZE_FACE]: `
Ты валидатор фотографий. Пользователь прислал одну фотографию, на которой должно быть чётко видно **лицо человека без очков**, при хорошем освещении и нейтральном выражении.

Оцени соответствие требованиям по шкале от -2 до +2 и верни **только JSON** в формате:

{ "rating": number }

Где:

-2 — вообще не лицо  
-1 — лицо плохо видно или в очках, или размыто  
 0 — что-то похожее на лицо, но есть сомнения  
+1 — лицо видно, но качество/освещение неидеальное  
+2 — лицо видно чётко, нейтральное выражение, всё ок

⚠️ Никаких пояснений, только JSON.
Если сомневаешься — снижай рейтинг.
`,
  [PromptKey.OPENAI_ANALYZE_PALM]: `Ты валидатор фотографий. Пользователь прислал одно фото, на котором должна быть чётко видна **ладонь** (вся кисть руки, включая пальцы). Допускаются открытые пальцы, небольшой наклон, лёгкая тень или неидеальный фон — это не должно снижать рейтинг.

Оцени соответствие по шкале от -2 до +2 и верни **ТОЛЬКО JSON**:

{ "rating": number }

-2 — это не ладонь  
-1 — ладонь почти не видна или сильно размыта  
 0 — что-то похожее на ладонь, но почти ничего не различимо  
+1 — ладонь видна, но присутствуют сильные помехи или плохой ракурс  
+2 — ладонь хорошо видна, несмотря на неидеальные условия

⚠️ Не добавляй объяснений. Только JSON.  
Если видна **ладонь с пальцами**, даже не идеально — это уже **не 0**.
`,

  [PromptKey.DEEPSEEK_FEELINGS_ANALYSIS]: `Проанализируй следующий текст и определи, содержит ли он описание чувств, эмоций или переживаний человека после просмотра результатов анализа его фотографий.

Текст пользователя: "\${text}"

Если текст содержит осмысленное описание чувств/эмоций/переживаний, верни JSON:
{
  "isValid": true,
  "analysis": "Краткий анализ эмоционального состояния пользователя"
}

Если текст НЕ содержит описания чувств (например, просто "ок", "спасибо", случайные символы, или не по теме), верни:
{
  "isValid": false
}

Отвечай ТОЛЬКО валидным JSON без дополнительного текста.`,

  [PromptKey.DEEPSEEK_BLOCK_HYPOTHESIS]: `На основе следующих данных создай блок-гипотезу о человеке, его амбициях и блоках:

Результат анализа фотографий: \${analysisDescription}
Описание чувств и амбиций: \${feelings}
Анализ эмоционального состояния: \${feelingsAnalysis}

Создай на 8-10 предложений блок-гипотезу, которая:
1. Объединяет визуальный анализ с эмоциональным состоянием
2. Формулирует основной внутренний блок или противоречие
3. Указывает на потенциальную точку роста
4. Написана в стиле психологического инсайта

Пиши в формате утверждения от третьего лица, как будто это вывод эксперта. Отправь результат без markdown вёрстки с двойными переносами строк между абзацами.`,

  [PromptKey.DEEPSEEK_SECOND_ORDER_HYPOTHESIS]: `Пользователь отклонил следующую гипотезу:
"\${previousHypothesis}"

Данные для анализа:
- Анализ фото: \${analysisDescription}
- Описание чувств: \${feelings}
Анализ эмоционального состояния: \${feelingsAnalysis}

Создай новую, на 8-10 более глубокую гипотезу второго порядка, которая:
1. Предлагает альтернативную интерпретацию, учитывая возможное сопротивление или более глубокие слои проблемы.
2. Фокусируется на менее очевидных связях между амбициями и внутренними блоками.
3. Написана в еще более эмпатичном и поддерживающем тоне.

Отправь результат без markdown вёрстки с двойными переносами строк между абзацами.`,

  [PromptKey.DEEPSEEK_VALIDATE_MESSAGE]: `Пользователь написал следующее сообщение: {message}


Проанализируй сообщение на запрещенный контент и повод отказа ИИ для его анализа, где
-2 - очень плохо (фашизм, нацизм, экстремизм и шовинизм и т.д.)
-1 - плохо (насилие, троллинг, моральная агрессия, нецензурная лексика и т.д.)
0 - недостаточно информации (содержит неотносящуюся к теме информацию)
1 - хорошо (относится к теме)

Сообщение должно содержать чувство человека, которое он должен проработать с помощью медитации, например: "Я недостаточно хорош", "А может еще рано", и т.д., а также прочие демотивирующие сообщения. Сообщение желательно должно быть демотивирующее, 3чтобы человек с помощью стратегии это проработал. 

Ответь пожалуйста просто цифрой в формате JSON 
{ 
"rating": number
}
`
};

/**
 * Проверяет, что все промпты загружены корректно
 * @returns объект с результатами валидации
 */
export function validateDefaultPrompts() {
  const validation = {
    valid: true,
    errors: [] as string[],
    warnings: [] as string[],
  };

  Object.entries(DEFAULT_PROMPTS).forEach(([key, content]) => {
    if (!content || content.trim().length === 0) {
      validation.valid = false;
      validation.errors.push(`Промпт ${key} пуст или не загружен`);
    } else if (content.length < 50) {
      validation.warnings.push(`Промпт ${key} кажется слишком коротким (${content.length} символов)`);
    }
  });

  return validation;
}
